{% extends '_base.html' %}

{% block head_css_extra %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@0.7.2/dist/leaflet.css" />
<link rel="stylesheet" href="{{ STATIC_URL }}css/vendor/leaflet.label.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
{% endblock %}

{% block head_javascript_extra %}
<script src="https://unpkg.com/leaflet@0.7.2/dist/leaflet.js"></script>
<script src="{{ STATIC_URL }}js/vendor/leaflet.label.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>
<script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
{% endblock %}

{% block body_id %}draw{% endblock %}

{% block content %}
<div id="map-controls" class="clearfix">
    <header class="box-header">
        <a class="title" href="{% url 'homepage' %}">
            <!-- <img src="{{ STATIC_URL }}img/logo.png"> --> State of the Detroit Child
        </a>
    </header>
    <div id="address-search-content" class="box-content">
        <section class="clearfix header-container" id="address-search-wrapper">
            <input type="text" id="address-search" placeholder="Search for an address">
            <a id="use-location" class="use-location-draw action-button"><i class="fa fa-location-arrow"></i></a>
        </section>
    </div>
    <div class="box-content">
        <section class="clearfix header-container">
            <select id="sumlev-picker" style="width: 100%;">
                <option> Select Geography </option>
            </select>
        </section>
    </div>
    <div class="box-content">
        <section class="clearfix header-container">
            <a id="draw-on-map" class="disabled action-button">Draw on Map <i class="fa fa-pencil-square"></i></a>
        </section>
        <h2 id="address-search-message" class="hidden bottom"></h2>
        <aside id="data-display" class="clearfix"></aside>
    </div>
</div>
<div id="slippy-map"></div>
<script id="place-result-template" type="text/template">
    <li data-geoid="<%= full_geoid %>">
        <a href="/profiles/<%= full_geoid %>">
            <i class="zoom-to-layer fa fa-arrows-alt" title="Zoom map to fit this shape"></i>
            <span class="glossary-term identifier"><%= SUMLEVELS[sumlevel].name %></span>
            <%= full_name %>
        </a>
    </li>
</script>
{% endblock %}

{% block body_javascript_extra %}
<!-- <script src='{{STATIC_URL}}js/vendor/leaflet.label.js'></script> -->
<script src="{{STATIC_URL}}js/draw.address.search.js"></script>
<script src="{{ STATIC_URL }}js/cr-leaflet.js"></script>
<script>
Glossary.init("{% url 'glossary' %}",".glossary-term");

// Allow Ajax POST requests to bypass Django's CSRF check
// https://docs.djangoproject.com/en/dev/ref/contrib/csrf/#ajax
var csrftoken = '{{ csrf_token }}';
function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

var sumlevs = [
    { 'level': '050', 'name': 'County', zoom: 7 },
    { 'level': '060', 'name': 'County Subdivision', zoom: 7 },
    { 'level': '140', 'name': 'Census Tract', zoom: 10 },
    { 'level': '150', 'name': 'Census Block Group', zoom: 15 },
    { 'level': '310', 'name': 'Metro (CBSA) area', zoom: 7 },
    { 'level': '400', 'name': 'Urban Area', zoom: 7 },
    { 'level': '500', 'name': 'Congressional District', zoom: 7 },
    { 'level': '610', 'name': 'State House (Upper)', zoom: 7 },
    { 'level': '620', 'name': 'State House (Lower)', zoom: 7 },
    { 'level': '860', 'name': 'ZIP Code', zoom: 12  },
    { 'level': '950', 'name': 'School District (Elementary)', zoom: 10  },
    { 'level': '960', 'name': 'School District (Secondary)', zoom: 10  },
    { 'level': '970', 'name': 'School District (Unified)', zoom: 10  }
]


var enabledLayer;

var defaultStyle = {
    "clickable": true,
    "color": "#76AFF2",
    "fillColor": "#f1f1f2",
    "weight": 1,
    "opacity": 0.5,
    "fillOpacity": 0.3,
};

var selectedStyle = {
    "clickable": true,
    "fillColor": "#9C65D1",
    "color": "#686867",
    "weight": 1,
    "opacity": 0.3,
    "fillOpacity": 0.3,
}

var makeLayer = function(thisSumlev) {

    var geojsonTileLayer;

    console.log(thisSumlev);
    if (CensusReporter.SummaryLevelLayer && thisSumlev !== "010") {
        geojsonTileLayer = new CensusReporter.SummaryLevelLayer(thisSumlev, {},
            {
            style: defaultStyle,
            onEachFeature: function(feature, layer) {
                // filter out non-Michingan results
                if (feature.properties.name.search(', MI') != -1 || feature.properties.geoid.search('86000US48') != -1 || feature.properties.geoid.search('86000US49') != -1) {
                    layer.bindLabel(feature.properties.name, {direction: 'auto'});
                    layer.on('mouseover', function() {
                        layer.setStyle({
                            "weight": 2,
                            "fillOpacity": 0.4,
                            "fillColor": "#76AFF2",
                        });
                    });
                    layer.on('mouseout', function() {
                        layer.setStyle(defaultStyle);
                    });
                    layer.on('click', function() {
                        // add spinner to page load 
                        var spinnerTarget = document.getElementById("body-spinner");
                        if (!spinnerTarget) {
                            $('body').append('<div id="body-spinner"></div>');
                            spinnerTarget = document.getElementById('body-spinner');
                        } 
                        spinner.spin(spinnerTarget);
                        window.location.href = '/profiles/' + feature.properties.geoid + '-' + slugify(feature.properties.name);
                    });
                } else {
                    var invisibleStyle = {
                        "clickable": false,
                        "color": "#fff",
                        "fillColor": "#fff",
                        "weight": 0,
                        "opacity": 0,
                        "fillOpacity": 0,
                    }
                    layer.setStyle(invisibleStyle);
                }
            }
        });
    } 
    enabledLayer = geojsonTileLayer;
    return geojsonTileLayer;
}

_.each(sumlevs,function(l) {
    $('<option>').val(l.level).text(l.name).appendTo('#sumlev-picker');
});


$("#sumlev-picker").change(function(e) {
    var sumlev = _.findWhere(sumlevs,{level: $(e.target).val()})
    if (sumlev) {
        /* 
        if (sumlev.zoom) {
            map.setZoom(sumlev.zoom);
        }
        */
        if (typeof sumlev.layer == 'undefined') {
            sumlev.layer = makeLayer(sumlev.level);
        }
        _.each(sumlevs,function(sl) {
            if (sl.layer && map.hasLayer(sl.layer)) {
                map.removeLayer(sl.layer);
            }
        })
        map.addLayer(sumlev.layer);
    }
});


// adding draw tools
var drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

var drawControl = new L.Control.Draw({
    draw: {
        polyline: false,
        polygon: true,
        rectangle: false,
        circle: false,
        marker: false,
        circlemarker: false,
    },
    edit: {
        featureGroup: drawnItems,
        edit: true
    }
});

var drawToggle = false;
$("#draw-on-map").click(function() {
    if (!drawToggle) {
        new L.Draw.Polygon(map, drawControl.options.polygon).enable();
        drawToggle = true;
    }
});

map.on('draw:created', function (e) {
    var drawnLayer = e.layer;
    //map.addLayer(drawnLayer);
    var drawnGeojson = drawnLayer.toGeoJSON();
    // loop through added geojson tiles
    console.log(enabledLayer.geojsonLayer);
    enabledLayer.geojsonLayer.eachLayer(function(layer) {
        //console.log(layer);
        var tileGeojson = layer.toGeoJSON();
        //console.log(tileGeojson.geometry.geometries[0]);
        var intersection = turf.intersect(drawnGeojson, tileGeojson.geometry.geometries[0]);
        //console.log(intersection);
        if (intersection) {
            layer.setStyle(selectedStyle);
            layer.on('mouseover', function() {
                layer.setStyle(selectedStyle);
            });
            layer.on('mouseout', function() {
                layer.setStyle(selectedStyle);
            });
            layer.on('click', function() {
            });
        }
        
    });

    drawToggle = false;
});



</script>
{% endblock %}
