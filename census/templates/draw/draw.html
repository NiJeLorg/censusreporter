{% extends '_base.html' %}

{% block head_css_extra %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@0.7.2/dist/leaflet.css" />
<link rel="stylesheet" href="{{ STATIC_URL }}css/vendor/leaflet.label.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
{% endblock %}

{% block head_javascript_extra %}
<script src="https://unpkg.com/leaflet@0.7.2/dist/leaflet.js"></script>
<script src="{{ STATIC_URL }}js/vendor/leaflet.label.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>
<script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
{% endblock %}

{% block body_id %}draw{% endblock %}

{% block content %}
<div id="map-controls" class="clearfix">
    <header class="box-header">
        <a class="title" href="{% url 'homepage' %}">
            <!-- <img src="{{ STATIC_URL }}img/logo.png"> --> State of the Detroit Child
        </a>
    </header>
    <div class="box-content">
        <section class="clearfix header-container draw-tools">
            <h1>Draw a shape to create a custom data dashboard</h1>
            <select id="sumlev-picker">
                <option>Select Geographic Building Blocks </option>
            </select>
            <a id="draw-on-map" class="action-button disabled"><i class="fa fa-pencil-square"></i> Draw on Map</a>
        </section>
        <section id="map-action-buttons" class="clearfix draw-tools hidden">
            <a id="clear-map" class="action-button">Clear Map</a>
            <a id="make-dashboard" class="action-button">Make Dashboard</a>
        </section>
    </div>
    <div id="address-search-content" class="box-content">
        <div class="tool-set header-tool-set draw-tools clearfix">
            <h1>OR</h1>
            <h1>Select a location to view an existing dashboard</h1>
            <a id="use-location" class="use-location action-button"><i class="fa fa-location-arrow"></i> Use your current location</a>
            <span class="no-map-hide">or double-click to place a marker</span>
        </div>
        <section class="clearfix header-container" id="address-search-wrapper">
            <input type="text" id="address-search" placeholder="Search for an address">
            <h2 id="address-search-message" class="hidden bottom"></h2>
            <aside id="data-display" class="clearfix"></aside>
        </section>
    </div>
</div>
<div id="slippy-map"></div>
<script id="place-result-template" type="text/template">
    <li data-geoid="<%= full_geoid %>">
        <a href="/profiles/<%= full_geoid %>">
            <i class="zoom-to-layer fa fa-arrows-alt" title="Zoom map to fit this shape"></i>
            <span class="glossary-term identifier"><%= SUMLEVELS[sumlevel].name %></span>
            <%= full_name %>
        </a>
    </li>
</script>
{% endblock %}

{% block body_javascript_extra %}
<!-- <script src='{{STATIC_URL}}js/vendor/leaflet.label.js'></script> -->
<script src="{{STATIC_URL}}js/draw.address.search.js"></script>
<script src="{{ STATIC_URL }}js/cr-leaflet.js"></script>
<script>
Glossary.init("{% url 'glossary' %}",".glossary-term");

// Allow Ajax POST requests to bypass Django's CSRF check
// https://docs.djangoproject.com/en/dev/ref/contrib/csrf/#ajax
var csrftoken = '{{ csrf_token }}';
function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

var sumlevs = [
    { 'level': '050', 'name': 'County', zoom: 7 },
    { 'level': '060', 'name': 'County Subdivision', zoom: 7 },
    { 'level': '140', 'name': 'Census Tract', zoom: 10 },
    { 'level': '150', 'name': 'Census Block Group', zoom: 15 },
    { 'level': '310', 'name': 'Metro (CBSA) area', zoom: 7 },
    { 'level': '400', 'name': 'Urban Area', zoom: 7 },
    { 'level': '500', 'name': 'Congressional District', zoom: 7 },
    { 'level': '610', 'name': 'State House (Upper)', zoom: 7 },
    { 'level': '620', 'name': 'State House (Lower)', zoom: 7 },
    { 'level': '860', 'name': 'ZIP Code', zoom: 12  },
    { 'level': '950', 'name': 'School District (Elementary)', zoom: 10  },
    { 'level': '960', 'name': 'School District (Secondary)', zoom: 10  },
    { 'level': '970', 'name': 'School District (Unified)', zoom: 10  }
]


var enabledLayer;

var defaultStyle = {
    "clickable": true,
    "color": "#76AFF2",
    "fillColor": "#f1f1f2",
    "weight": 1,
    "opacity": 0.5,
    "fillOpacity": 0.3,
};

var selectedStyle = {
    "clickable": true,
    "fillColor": "#9C65D1",
    "color": "#686867",
    "weight": 1,
    "opacity": 0.3,
    "fillOpacity": 0.3,
}


var makeTileLayer = function(thisSumlev) {

    var geojsonTileLayer;

    if (CensusReporter.SummaryLevelLayer && thisSumlev !== "010") {
        geojsonTileLayer = new CensusReporter.SummaryLevelLayer(thisSumlev, {},
            {
            style: defaultStyle,
            onEachFeature: function(feature, layer) {
                // filter out non-Michingan results
                if (feature.properties.name.search(', MI') != -1 || feature.properties.geoid.search('86000US48') != -1 || feature.properties.geoid.search('86000US49') != -1) {
                    setDefault(feature, layer);
                } else {
                    var invisibleStyle = {
                        "clickable": false,
                        "color": "#fff",
                        "fillColor": "#fff",
                        "weight": 0,
                        "opacity": 0,
                        "fillOpacity": 0,
                    }
                    layer.setStyle(invisibleStyle);
                }
            }
        });
    } 
    return geojsonTileLayer;
}

_.each(sumlevs,function(l) {
    $('<option>').val(l.level).text(l.name).appendTo('#sumlev-picker');
});


$("#sumlev-picker").change(function(e) {
    var sumlev = _.findWhere(sumlevs,{level: $(e.target).val()})
    if (sumlev) {
        /* 
        if (sumlev.zoom) {
            map.setZoom(sumlev.zoom);
        }
        */

        // Enable the draw button
        $("#draw-on-map").removeClass('disabled');

        if (typeof sumlev.layer == 'undefined') {
            sumlev.layer = makeTileLayer(sumlev.level);
            enabledLayer = sumlev.layer;
        }
        _.each(sumlevs,function(sl) {
            if (sl.layer && map.hasLayer(sl.layer)) {
                map.removeLayer(sl.layer);
            }
        })
        map.addLayer(sumlev.layer);

        // remove point_marker, hover shapes, message and list of geograpies if they exist
        if (point_marker) {
            point_marker.hideLabel();
            point_marker.setLatLng(L.latLng(0,0));
            _(PLACE_LAYERS).each(function(v,k) {
                map.removeLayer(v);
            });
            $("#address-search-message").hide();
            $("#data-display").html("");
        }
    } else {
        // Disable draw button
        $("#draw-on-map").addClass('disabled');
        _.each(sumlevs,function(sl) {
            if (sl.layer && map.hasLayer(sl.layer)) {
                map.removeLayer(sl.layer);
            }
        })
    }
    // always hide clear and make dashboard buttons
    $("#map-action-buttons").addClass("hidden");
});


// adding draw tools
var drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

var drawControl = new L.Control.Draw({
    draw: {
        polyline: false,
        polygon: true,
        rectangle: false,
        circle: false,
        marker: false,
        circlemarker: false,
    },
    edit: {
        featureGroup: drawnItems,
        edit: true
    }
});

var drawToggle = false;
$("#draw-on-map").click(function() {
    if (!drawToggle) {
        new L.Draw.Polygon(map, drawControl.options.polygon).enable();
        drawToggle = true;
    }
    // set up map for draw mode
    $("#draw-on-map").addClass("active");
    map.removeLayer(regularBackgroundTiles);
    map.addLayer(drawBackgroundTiles);
});

$("#clear-map").click(function() {
    // hide clear and make dashboard buttons
    $("#map-action-buttons").addClass("hidden");
    // loop through each layer and reset style and event listeners
    enabledLayer.geojsonLayer.eachLayer(function(layer) {
        setDefault(layer.feature, layer);
    });
});

var setDefault = function(feature, layer) {
    layer.removeEventListener();
    layer.setStyle(defaultStyle);
    layer.bindLabel(feature.properties.name, {direction: 'auto'});
    layer.on('mouseover', function() {
        layer.setStyle({
            "weight": 2,
            "fillOpacity": 0.4,
            "fillColor": "#76AFF2",
        });
    });
    layer.on('mouseout', function() {
        layer.setStyle(defaultStyle);
    });
    layer.on('click', function() {
        // add spinner to page load 
        // var spinnerTarget = document.getElementById("body-spinner");
        // if (!spinnerTarget) {
        //    $('body').append('<div id="body-spinner"></div>');
        //    spinnerTarget = document.getElementById('body-spinner');
        // } 
        // spinner.spin(spinnerTarget);
        // window.location.href = '/profiles/' + feature.properties.geoid + '-' + slugify(feature.properties.name);
    });
}

var setSelected = function(layer) {
    layer.removeEventListener();
    layer.setStyle(selectedStyle);
    // update label
    layer.unbindLabel();
    layer.bindLabel("Remove " + layer.feature.properties.name + " from selection.", {direction: 'auto'});
    // set up new listeners
    layer.on('mouseover', function() {
        layer.setStyle({
            "weight": 2,
            "fillOpacity": 0.4,
            "fillColor": "#6828A6",
        });
    });
    layer.on('mouseout', function() {
        layer.setStyle(selectedStyle);
    });
    layer.on('click', function() {
        setDeselected(layer);
    });
}

var setDeselected = function(layer) {
    layer.removeEventListener();
    layer.setStyle(defaultStyle);
    // update label
    layer.unbindLabel();
    layer.bindLabel("Add " + layer.feature.properties.name + " to selection.", {direction: 'auto'});
    // set up new listeners
    layer.on('mouseover', function() {
        layer.setStyle({
            "weight": 2,
            "fillOpacity": 0.4,
            "fillColor": "#76AFF2",
        });
    });
    layer.on('mouseout', function() {
        layer.setStyle(defaultStyle);
    });
    layer.on('click', function() {
        setSelected(layer);   
    });
}

map.on('draw:created', function (e) {
    // take map out of draw mode
    $("#draw-on-map").removeClass("active");
    map.removeLayer(drawBackgroundTiles);
    map.addLayer(regularBackgroundTiles);

    // show clear and make dashboard buttons
    $("#map-action-buttons").removeClass("hidden");

    var drawnLayer = e.layer;
    //map.addLayer(drawnLayer);
    var drawnGeojson = drawnLayer.toGeoJSON();
    // loop through added geojson tiles
    // console.log(enabledLayer.geojsonLayer);
    enabledLayer.geojsonLayer.eachLayer(function(layer) {
        //console.log(layer);
        var tileGeojson = layer.toGeoJSON();
        //console.log(tileGeojson.geometry.geometries[0]);
        var intersection = turf.intersect(drawnGeojson, tileGeojson.geometry.geometries[0]);
        //console.log(intersection);
        if (intersection) {
            setSelected(layer);
        } else {
            setDeselected(layer);
        }
        
    });

    drawToggle = false;
});



</script>
{% endblock %}
